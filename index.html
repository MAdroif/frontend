<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Slide Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out; }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .neon-blue {
      background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
    }
    .neon-blue:hover {
      background: linear-gradient(135deg, #00e1fe 0%, #3a9bfe 100%);
      box-shadow: 0 0 20px rgba(79,172, 254, 0.5);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
  
  <!-- Notification Toast -->
  <div id="notification" class="fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg hidden items-center gap-2 text-white"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transition-transform duration-300 z-40 overflow-y-auto" style="transform: translateX(0)">
    <div class="p-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">BuildHub</h2>
        <button onclick="toggleSidebar()" class="lg:hidden">
          <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div id="history-container" class="space-y-6"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="transition-all duration-300" style="margin-left: 16rem">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 py-3 flex items-center justify-between sticky top-0 z-30">
      <button onclick="toggleSidebar()" class="text-gray-600 dark:text-gray-400">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      
      <div class="flex items-center gap-2">
        <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg id="sun-icon" class="w-5 h-5 text-gray-600 dark:text-gray-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <svg id="moon-icon" class="w-5 h-5 text-gray-600 dark:text-gray-400 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Dashboard -->
    <main class="p-4 max-w-4xl mx-auto">
      <!-- Welcome Section -->
      <div class="text-center mb-8 mt-8">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600"></div>
        </div>
        <h1 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Selamat datang di Carousel Generator!</h1>
        <p class="text-gray-600 dark:text-gray-400">Di mana imajinasi bertemu dengan desain bertenaga AI untuk membuat slide Anda hari ini!</p>
      </div>

      <!-- Generation Form -->
      <div class="rounded-2xl bg-white dark:bg-gray-800 shadow-lg border border-gray-200 dark:border-gray-700">
        <!-- Advanced Options -->
        <div class="px-6 pt-6">
          <button onclick="toggleAdvanced()" class="flex items-center gap-2 text-sm font-medium pb-4 text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition-colors">
            <svg id="chevron-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            Advanced Options
          </button>
          
          <div id="advanced-options" class="hidden pb-4 space-y-3">
            <div>
              <label class="block text-xs font-medium mb-1.5 text-gray-600 dark:text-gray-400">Creator Name</label>
              <input type="text" id="creator-name" placeholder="Enter creator name" class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            </div>
            
            <div>
              <label class="block text-xs font-medium mb-1.5 text-gray-600 dark:text-gray-400">Template Style</label>
              <select id="template" class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <option value="modern">Modern Template</option>
                <option value="minimal">Minimal Template</option>
                <option value="creative">Creative Template</option>
                <option value="corporate">Corporate Template</option>
              </select>
            </div>
            
            <div>
              <label class="block text-xs font-medium mb-1.5 text-gray-600 dark:text-gray-400">Voice Tone</label>
              <select id="voice-tone" class="w-full px-3 py-2 rounded-lg text-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <option value="professional">Professional</option>
                <option value="casual">Casual</option>
                <option value="enthusiastic">Enthusiastic</option>
                <option value="formal">Formal</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="hidden px-6 pb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-600 dark:text-gray-400">Generating slides... <span id="progress-percent">0</span>%</span>
          </div>
          <div class="w-full h-2 rounded-full overflow-hidden bg-gray-200 dark:bg-gray-700">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-cyan-500 to-blue-600 transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        
        <!-- Chat Input Area -->
        <div class="p-6 pt-0">
          <div class="flex items-end gap-3 p-3 rounded-xl border bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
            <textarea id="script-input" placeholder="Tell us about your presentation..." rows="3" class="flex-1 bg-transparent resize-none focus:outline-none text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"></textarea>
            <button onclick="handleGenerate()" id="send-btn" class="p-3 rounded-lg transition-all flex-shrink-0 neon-blue shadow-lg">
              <svg id="send-icon" class="text-white w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
              <svg id="loader-icon" class="text-white w-5 h-5 animate-spin hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </button>
          </div>
          <p class="text-xs mt-2 text-gray-400 dark:text-gray-500">Press Enter to send, Shift + Enter for new line</p>
        </div>
      </div>

      <!-- Feature Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
        <div class="p-4 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mb-3">
            <span class="text-white text-xl">üìù</span>
          </div>
          <h3 class="font-semibold mb-1 text-gray-900 dark:text-white">Samples</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Use pre-made templates for quick starts</p>
        </div>
        
        <div class="p-4 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mb-3">
            <span class="text-white text-xl">üé®</span>
          </div>
          <h3 class="font-semibold mb-1 text-gray-900 dark:text-white">Select Materials</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Choose from various design elements</p>
        </div>
        
        <div class="p-4 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
          <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mb-3">
            <span class="text-white text-xl">‚ö°</span>
          </div>
          <h3 class="font-semibold mb-1 text-gray-900 dark:text-white">AI-Powered</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">Smart generation with AI assistance</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ==================== GANTI WEBHOOK URL DI SINI ====================
    const SUBMIT_WEBHOOK = 'https://n8n-vogmx0uye8x5.arman.sumopod.my.id/webhook/v5';  // ‚Üê GANTI INI
    const STATUS_WEBHOOK = 'https://n8n-vogmx0uye8x5.arman.sumopod.my.id/webhook/pollingv5';  // ‚Üê GANTI INI
    // ===================================================================

    let isGenerating = false;
    let sidebarOpen = true;
    let darkMode = localStorage.getItem('darkMode') === 'true';
    if (localStorage.getItem('darkMode') === null) {
      darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    let history = JSON.parse(localStorage.getItem('slideHistory') || '[]');

    // Initialize
    // Initialize dark mode
    if (darkMode) {
      document.documentElement.classList.add('dark');
      document.getElementById('sun-icon').classList.remove('hidden');
      document.getElementById('moon-icon').classList.add('hidden');
    } else {
      document.documentElement.classList.remove('dark');
      document.getElementById('sun-icon').classList.add('hidden');
      document.getElementById('moon-icon').classList.remove('hidden');
    }
    
    // Set initial sidebar state for desktop
    //if (window.innerWidth >= 1024) {
    //  document.getElementById('main-content').style.marginLeft = '16rem';
    //} else {
    //  sidebarOpen = false;
    //  document.getElementById('sidebar').style.transform = 'translateX(-100%)';
    //  document.getElementById('main-content').style.marginLeft = '0';
    //}
    // Set initial sidebar state - hidden by default
    sidebarOpen = false;
    document.getElementById('sidebar').style.transform = 'translateX(-100%)';
    document.getElementById('main-content').style.marginLeft = '0';
    
    renderHistory();

    // Toggle functions
    function toggleSidebar() {
      sidebarOpen = !sidebarOpen;
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      
      if (sidebarOpen) {
        sidebar.style.transform = 'translateX(0)';
        if (window.innerWidth >= 1024) {
          mainContent.style.marginLeft = '16rem';
        }
      } else {
        sidebar.style.transform = 'translateX(-100%)';
        mainContent.style.marginLeft = '0';
      }
    }

    function toggleDarkMode() {
      darkMode = !darkMode;
      localStorage.setItem('darkMode', darkMode);
      
      if (darkMode) {
        document.documentElement.classList.add('dark');
        document.getElementById('sun-icon').classList.remove('hidden');
        document.getElementById('moon-icon').classList.add('hidden');
      } else {
        document.documentElement.classList.remove('dark');
        document.getElementById('sun-icon').classList.add('hidden');
        document.getElementById('moon-icon').classList.remove('hidden');
      }
    }

    function toggleAdvanced() {
      const options = document.getElementById('advanced-options');
      const chevron = document.getElementById('chevron-icon');
      
      if (options.classList.contains('hidden')) {
        options.classList.remove('hidden');
        chevron.style.transform = 'rotate(180deg)';
      } else {
        options.classList.add('hidden');
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 text-white animate-fade-in ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      
      const icon = type === 'success' 
        ? '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
        : '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
      
      notification.innerHTML = icon + '<span>' + message + '</span>';
      notification.classList.remove('hidden');
      
      setTimeout(() => {
        notification.classList.add('hidden');
      }, 4000);
    }

    function renderHistory() {
      const container = document.getElementById('history-container');
      
      if (history.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No history yet</p>';
        return;
      }

      const grouped = groupHistoryByDate(history);
      let html = '';

      for (const [period, items] of Object.entries(grouped)) {
        if (items.length > 0) {
          html += `
            <div>
              <h3 class="text-sm font-semibold mb-2 text-gray-600 dark:text-gray-400">${period}</h3>
              <div class="space-y-2">
                ${items.map(item => `
                  <div class="p-2 rounded-lg cursor-pointer hover:bg-gray-900 hover:bg-opacity-10 dark:hover:bg-white dark:hover:bg-opacity-10">
                    <p class="text-sm truncate text-gray-700 dark:text-gray-300">${item.script}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
      }

      container.innerHTML = html;
    }

    function groupHistoryByDate(items) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      const threeDaysAgo = new Date(today);
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      const sevenDaysAgo = new Date(today);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const groups = {
        'Today': [],
        'Yesterday': [],
        '3 days ago': [],
        '7 days ago': [],
        'Last 30 days': []
      };

      items.forEach(item => {
        const itemDate = new Date(item.timestamp);
        if (itemDate >= today) {
          groups['Today'].push(item);
        } else if (itemDate >= yesterday) {
          groups['Yesterday'].push(item);
        } else if (itemDate >= threeDaysAgo) {
          groups['3 days ago'].push(item);
        } else if (itemDate >= sevenDaysAgo) {
          groups['7 days ago'].push(item);
        } else {
          groups['Last 30 days'].push(item);
        }
      });

      return groups;
    }

    async function pollStatus(jobId, script) {
      let attempts = 0;
      const maxAttempts = 100;
      
      async function poll() {
        if (attempts >= maxAttempts) {
          isGenerating = false;
          updateUI();
          showNotification('Generation timeout. Please try again.', 'error');
          return;
        }
        
        try {
          console.log('Polling status for job:', jobId);
          
          const response = await fetch(STATUS_WEBHOOK, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ job_id: jobId })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Polling response:', data);
          
          if (data.progress) {
            document.getElementById('progress-percent').textContent = data.progress;
            document.getElementById('progress-bar').style.width = data.progress + '%';
          }
          
          if (data.status === 'completed' || data.status === 'COMPLETED') {
            isGenerating = false;
            updateUI();
            
            const newItem = {
              id: Date.now(),
              script: script.substring(0, 100) + '...',
              slides: data.slides || [],
              creatorName: document.getElementById('creator-name').value,
              template: document.getElementById('template').value,
              timestamp: new Date().toISOString(),
              jobId
            };
            
            history.unshift(newItem);
            localStorage.setItem('slideHistory', JSON.stringify(history));
            renderHistory();
            
            showNotification('Slides generated successfully!', 'success');
            document.getElementById('script-input').value = '';
            document.getElementById('progress-bar').style.width = '0%';
          } else if (data.status === 'failed' || data.status === 'Failed') {
            isGenerating = false;
            updateUI();
            showNotification('Generation failed. Please try again.', 'error');
          } else {
            attempts++;
            setTimeout(poll, 3000);
          }
        } catch (error) {
          console.error('Polling error:', error);
          isGenerating = false;
          updateUI();
          
          if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            showNotification('Network error during polling. Retrying...', 'error');
            attempts++;
            if (attempts < maxAttempts) {
              setTimeout(poll, 3000);
            }
          } else {
            showNotification('Error checking status: ' + error.message, 'error');
          }
        }
      }
      
      poll();
    }

    async function handleGenerate() {
      const script = document.getElementById('script-input').value.trim();
      
      if (!script) {
        showNotification('Please enter a script', 'error');
        return;
      }
      
      if (!SUBMIT_WEBHOOK.includes('http') || !STATUS_WEBHOOK.includes('http')) {
        showNotification('Please configure webhook URLs in the code', 'error');
        return;
      }
      
      isGenerating = true;
      updateUI();
      
      try {
        console.log('Sending request to:', SUBMIT_WEBHOOK);
        
        const response = await fetch(SUBMIT_WEBHOOK, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            script,
            creator_name: document.getElementById('creator-name').value || '',
            template: document.getElementById('template').value,
            voice_tone: document.getElementById('voice-tone').value
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        // Support both jobId and job_id formats
        const jobId = data.jobId || data.job_id;
        
        if (jobId) {
          showNotification('Generation started...', 'info');
          pollStatus(jobId, script);
        } else {
          console.error('No job ID in response:', data);
          throw new Error('No job ID received. Response: ' + JSON.stringify(data));
        }
      } catch (error) {
        console.error('Fetch error:', error);
        isGenerating = false;
        updateUI();
        
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
          showNotification('Network error: Cannot connect to server. Check your internet connection and CORS settings.', 'error');
        } else {
          showNotification('Error starting generation: ' + error.message, 'error');
        }
      }
    }

    function updateUI() {
      const sendBtn = document.getElementById('send-btn');
      const sendIcon = document.getElementById('send-icon');
      const loaderIcon = document.getElementById('loader-icon');
      const progressContainer = document.getElementById('progress-container');
      
      if (isGenerating) {
        sendBtn.disabled = true;
        sendBtn.classList.remove('neon-blue');
        sendBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
        sendIcon.classList.add('hidden');
        loaderIcon.classList.remove('hidden');
        progressContainer.classList.remove('hidden');
      } else {
        sendBtn.disabled = false;
        sendBtn.classList.add('neon-blue');
        sendBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
        sendIcon.classList.remove('hidden');
        loaderIcon.classList.add('hidden');
        progressContainer.classList.add('hidden');
      }
    }

    // Keyboard shortcuts
    document.getElementById('script-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleGenerate();
      }
    });
  </script>
</body>
</html>
